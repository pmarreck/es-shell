#!/usr/bin/env bash
set -euo pipefail

runs="${BM_RUNS:-5}"
warmup="${BM_WARMUP:-1}"
seed="${BM_SEED:-424242}"
log_file="bench/algos-bench.log"

mkdir -p bench

usage() {
	cat >&2 <<'USAGE'
usage: bm [algorithm...]

algorithms:
  mandelbrot
  base64
  primes
  strings
  dprng
USAGE
	exit 2
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
	usage
fi

if ! command -v hyperfine >/dev/null 2>&1; then
	echo "error: hyperfine is required (use nix develop -c ./bm)" >&2
	exit 1
fi

make -j"$(getconf _NPROCESSORS_ONLN 2>/dev/null || echo 4)" >/dev/null

timestamp="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

{
	echo "## ${timestamp}"
	echo "- runs: ${runs}"
	echo "- warmup: ${warmup}"
	echo "- seed: ${seed}"
	echo
} >>"$log_file"

run_case() {
	local label="$1"
	local bash_cmd="$2"
	local es_cmd="$3"
	local awk_cmd="${4:-}"
	local report

	report="$(mktemp "${TMPDIR:-/tmp}/es-bm-report.XXXXXX.md")"

	echo
	echo "=== ${label} ==="

	if [[ -n "$awk_cmd" ]]; then
		hyperfine \
			--warmup "$warmup" \
			--runs "$runs" \
			--command-name "es" "$es_cmd" \
			--command-name "bash" "$bash_cmd" \
			--command-name "awk" "$awk_cmd" \
			--export-markdown "$report"
	else
		hyperfine \
			--warmup "$warmup" \
			--runs "$runs" \
			--command-name "es" "$es_cmd" \
			--command-name "bash" "$bash_cmd" \
			--export-markdown "$report"
	fi

	cat "$report"
	{
		echo "### ${label}"
		cat "$report"
		echo
	} >>"$log_file"
	rm -f "$report"
}

declare -a algorithms
if [[ "$#" -eq 0 ]]; then
	algorithms=(mandelbrot base64 primes strings dprng)
else
	algorithms=("$@")
fi

for algorithm in "${algorithms[@]}"; do
	case "$algorithm" in
		mandelbrot)
			w="${BM_MANDEL_WIDTH:-84}"
			h="${BM_MANDEL_HEIGHT:-36}"
			mi="${BM_MANDEL_MAXITER:-60}"
			run_case \
				"mandelbrot" \
				"bash bench/es-vs-bash-algos.bash mandelbrot ${w} ${h} ${mi}" \
				"./es -p bench/es-vs-bash-algos.es mandelbrot ${w} ${h} ${mi}" \
				"awk -v width=${w} -v height=${h} -v maxiter=${mi} -f bench/mandelbrot.awk | wc -c >/dev/null"
			;;
		base64)
			rows="${BM_B64_ROWS:-2000}"
			rounds="${BM_B64_ROUNDS:-4}"
			run_case \
				"base64-roundtrip" \
				"bash bench/es-vs-bash-algos.bash base64 ${rows} ${rounds} ${seed}" \
				"./es -p bench/es-vs-bash-algos.es base64 ${rows} ${rounds} ${seed}" \
				""
			;;
		primes)
			limit="${BM_PRIME_LIMIT:-60}"
			run_case \
				"primes" \
				"bash bench/es-vs-bash-algos.bash primes ${limit}" \
				"./es -p bench/es-vs-bash-algos.es primes ${limit}" \
				"awk -v limit=${limit} -f bench/primes.awk >/dev/null"
			;;
		strings)
			tokens="${BM_STR_TOKENS:-1000}"
			rounds="${BM_STR_ROUNDS:-20}"
			run_case \
				"strings" \
				"bash bench/es-vs-bash-algos.bash strings ${tokens} ${rounds} ${seed}" \
				"./es -p bench/es-vs-bash-algos.es strings ${tokens} ${rounds} ${seed}" \
				"awk -v tokens=${tokens} -v rounds=${rounds} -v seed=${seed} -f bench/strings.awk >/dev/null"
			;;
		dprng)
			count="${BM_DPRNG_COUNT:-80}"
			run_case \
				"dprng" \
				"bash bench/es-vs-bash-algos.bash dprng ${count} ${seed}" \
				"./es -p bench/es-vs-bash-algos.es dprng ${count} ${seed}" \
				"awk -v mode=numbers -v count=${count} -v seed=${seed} -f bench/dprng.awk >/dev/null"
			;;
		*)
			echo "unknown algorithm: ${algorithm}" >&2
			usage
			;;
	esac
done

echo
echo "Logged benchmark results to ${log_file}"
